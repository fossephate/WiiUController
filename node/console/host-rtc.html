<html>

<head>
	<title>Lagless audio host</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
	<script src="js/simplepeer.min.js"></script>
	<script src="js/peer.min.js"></script>

</head>

<body>

	<style>
		#outgoing {
			width: 600px;
			word-wrap: break-word;
		}
	</style>
	<form>
		<textarea id="incoming"></textarea>
		<button type="submit">submit</button>
	</form>
	<pre id="outgoing"></pre>

	<script>
		
		
		var peer;
		let socket = io("https://twitchplaysnintendoswitch.com", {
			path: "/8110/socket.io",
			transports: ["websocket"],
		});
		
		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
		navigator.mediaDevices.getUserMedia({audio: true, video: false}).then(function(stream) {
			
			peer = new SimplePeer({
				initiator: true,
				trickle: false,
				stream: stream,
			});

			peer.on("signal", function(data) {
				// get this to the client:
				socket.emit("host-signal", data);
				console.log("SIGNAL", JSON.stringify(data));
// 				document.querySelector("#outgoing").textContent = JSON.stringify(data);
			});
			
			
// 			peer._setupData({
// 				channel: peer._pc.createDataChannel(peer.channelName, peer.channelConfig)
// 			});
// 			peer._needsNegotiation();
			
			setInterval(function() {
				peer._createOffer();
			}, 1000);

// 			document.querySelector("form").addEventListener("submit", function(ev) {
// 				ev.preventDefault();
// 				peer.signal(JSON.parse(document.querySelector("#incoming").value));
// 			});
			
			socket.on("client-signal", function(data) {
				peer.signal(data);
			});

			peer.on("connect", function() {
				console.log("CONNECT");
				peer.send("whatever" + Math.random());
			});

			peer.on("data", function(data) {
				console.log("data: " + data);
			});
			
			peer.on("connect", function(data) {
				console.log("connect: " + data);
			});
			
			peer.on("error", function(err) {
				console.log("error", err)
			});
			
		});
		



		
// 		let socket = io("https://twitchplaysnintendoswitch.com", {
// 			path: "/8110/socket.io",
// 			transports: ["websocket"],
// 		});
		
// 		var peer = new Peer("twitchplaysnintendoswitch-host", {host: "twitchplaysnintendoswitch.com", port: 80, path: "/8004/twitchplays"});
		
// 		peer.on("connection", function(conn) {
// 			conn.on("data", function(data){
// 				// Will print 'hi!'
// 				console.log(data);
// 			});
// 		});
		
// 		// call client:
// 		navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
// 		navigator.mediaDevices.getUserMedia({audio: true, video: false}).then(function(stream) {
// 			var call = peer.call("twitchplaysnintendoswitch-client", stream);
// 		});
		
	</script>
</body>

</html>