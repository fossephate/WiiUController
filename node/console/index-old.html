<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<script type="text/javascript" src="keymaster.js"></script>
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" /> -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
<link rel="stylesheet" href="css/stylesheet.css">
<script src="js/gamepad.js"></script>
<script src="js/localforage.min.js"></script>
<script src="js/rangeslider.min.js"></script>
<script src="js/tools.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.6.8/nipplejs.min.js"></script>
<!-- <script src="js/bootstrap-modal.js"></script> -->
<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- <script src="js/bootstrap-slider.min.js"></script> -->

<script>
	var socket;
	// 	socket = io('https://fosse.co', {
	// 		path: '/8110/socket.io'
	// 	});

	socket = io("https://twitchplaysnintendoswitch.com", {
		path: "/8110/socket.io",
		transports: ['websocket'] // added
	});
	// 	socket = io('fosse.co:8080');
	//socket = io("http://fosse.co:80");
	//socket = io("http://fosse.co:80/8110/socket.io");
</script>

<html>


<style>
</style>

<body>

	<div id="metaContainer">

		<div id="container" class="container2">

			<div id="picture" class="one well" oncontextmenu="return false">

				<!-- <image id="screenshot"></image> -->
				<div id="screen"></div>
				
				
				<div id="touchControls" class="container5">
					<div id="leftStick" class="zone semi seven">
					</div>
					<div id="rightStick" class="zone semi eight">
					</div>
				</div>




				<div id="description">

					<div id="barUnderTheStream" class="well">
						<div class="container4">
							<div class="checkbox five">
								<label class="checkbox-bootstrap checkbox-lg">                                        
									<input id="keyboardController" type="checkbox">             
									<span class="checkbox-placeholder"></span>           
									Control with keyboard / or a controller
								</label>
							</div>
							<div class="checkbox">
								<label class="checkbox-bootstrap checkbox-lg">                                        
									<input id="touchControlsCheckbox" type="checkbox">             
									<span class="checkbox-placeholder"></span>           
									Touch Controls
								</label>
							</div>

							<div id="currentPlayer" class="six">
								Current Player:
							</div>
						</div>
					</div>

					<div class="container3 well">

						<div class="three">
							<div id="settingsLabel" class="well">
								Settings:
							</div>
							<div id="streamSettings" class="well">
								<button type="button" data-toggle="modal" data-target="#settingsWindow" class="btn btn-info btn-settings">
									<i class="glyphicon glyphicon-cog"></i>
								</button>
								<a id="authenticateButton" href="/8110/auth/twitch"><img src="https://ttv-api.s3.amazonaws.com/assets/connect_dark.png"></a>

								<div class="sliderContainer">
									Quality: <span id="quality">70</span>
									<input id="qualitySlider" class="slider" type="range" min="1" step="5" max="90" value="70">
									<!-- 							<div id="qualitySlider"></div> -->
								</div>
								<div class="sliderContainer">
									Scale: <span id="scale">30</span>
									<input id="scaleSlider" class="slider" type="range" min="10" step="1" max="60" value="30">
								</div>
								<div class="sliderContainer">
									FPS: <span id="fps">15</span>
									<input id="fpsSlider" class="slider" type="range" min="1" step="1" max="15" value="15">
								</div>
								<div class="sliderContainer">
									Threshold: <span id="threshold">5</span>
									<input id="thresholdSlider" class="slider" type="range" min="1" step="1" max="128" value="5">
								</div>
							</div>
						</div>


						<div class="four">
							<div id="controlsLabel" class="well">
								Controls:
							</div>
							<div id="controls" class="well">
								<ul class="list-group">
									<li class="list-group-item">Controller Support:</li>
									<li class="list-group-item">If you have an XBOX or Playstation Controller, just plug it in!</li>
									<li class="list-group-item">To use a Pro Controller or JoyCons, you'll need a bluetooth adapter, and a bit of setup:</li>
									<li class="list-group-item">follow the instructions here: https://github.com/mfosse/JoyCon-Driver/</li>
								</ul>
								<ul class="list-group">
									<li class="list-group-item">Default Keyboard Controls:</li>
									<li class="list-group-item">W/A/S/D = Left Stick</li>
									<li class="list-group-item">I/J/K/L = Right Stick</li>
									<li class="list-group-item">T/F/G/H = DPad</li>
									<li class="list-group-item">Arrow Keys = A/B/X/Y</li>
									<li class="list-group-item">- = Minus</li>
									<li class="list-group-item">Q/E = ZL / ZR</li>
									<li class="list-group-item">U/O = L / R</li>
									<li class="list-group-item">R/Y = LStick / RStick buttons</li>
								</ul>
							</div>
						</div>

					</div>

					<iframe id="twitchvideo" class="well" src="https://player.twitch.tv/?channel=twitchplaysconsoles&muted=false&autoplay=true" height="360" width="640" frameborder="0" scrolling="no" allowfullscreen="true">
					</iframe>

				</div>



			</div>

			<!-- 			<div id="chat" class="two">
				Chat
				<div id="messages">
					<ul id="messageList"></ul>
				</div>

				<form id="chatForm" class="form-inline">
					<div class="form-group-invalid">
						<input id="msgInput" class="form-control" type="text" autocomplete="off" />
						<button id="sendButton" class="btn btn-primary" type="submit">Send</button>
					</div>
				</form>
			</div> -->

			<iframe id="twitchchat" class="two" frameborder="0" scrolling="no" id="chat_embed" src="https://www.twitch.tv/embed/twitchplaysconsoles/chat" height="500" width="350">
			</iframe>

		</div>



	</div>


	<!-- SETTINGS WINDOW ------------------------------------------- -->
	<div class="modal fade" id="settingsWindow" role="dialog">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">

				<div class="modal-header">
					<h3 class="modal-title text-center">Settings</h3>
				</div>

				<div class="modal-body">

					<ul class="nav nav-tabs nav-justified">
						<li class="active"><a href="#keyboardSettingsFrame" data-toggle="tab">keyboard</a></li>
						<!-- 						<li><a href="#soundSettingsFrame" data-toggle="tab">sound</a></li>
						<li><a href="#videoSettingsFrame" data-toggle="tab">video</a></li> -->
					</ul>

					<div class="tab-content">
						<div class="tab-pane active" id="keyboardSettingsFrame">

							<div id="keyboardLayoutConfig">
								<!-- <tabindex="0"> -->
								<div class="actionText">Left Stick Up</div>
								<div class="buttonConfig" id="LYU"></div><br>
								<div class="actionText">Left Stick Down</div>
								<div class="buttonConfig" id="LYD"></div><br>
								<div class="actionText">Left Stick Left</div>
								<div class="buttonConfig" id="LXL"></div><br>
								<div class="actionText">Left Stick Right</div>
								<div class="buttonConfig" id="LXR"></div><br>
								<div class="actionText">Right Stick Up</div>
								<div class="buttonConfig" id="RYU"></div><br>
								<div class="actionText">Right Stick Down</div>
								<div class="buttonConfig" id="RYD"></div><br>
								<div class="actionText">Right Stick Left</div>
								<div class="buttonConfig" id="RXL"></div><br>
								<div class="actionText">Right Stick Right</div>
								<div class="buttonConfig" id="RXR"></div><br>
								<div class="actionText">A</div>
								<div class="buttonConfig" id="A"></div><br>
								<div class="actionText">B</div>
								<div class="buttonConfig" id="B"></div><br>
								<div class="actionText">X</div>
								<div class="buttonConfig" id="X"></div><br>
								<div class="actionText">Y</div>
								<div class="buttonConfig" id="Y"></div><br>
								<div class="actionText">DPad Up</div>
								<div class="buttonConfig" id="DUP"></div><br>
								<div class="actionText">DPad Down</div>
								<div class="buttonConfig" id="DDown"></div><br>
								<div class="actionText">DPad Left</div>
								<div class="buttonConfig" id="DLeft"></div><br>
								<div class="actionText">DPad Right</div>
								<div class="buttonConfig" id="DRight"></div><br>
								<div class="actionText">LStick Button</div>
								<div class="buttonConfig" id="LStick"></div><br>
								<div class="actionText">RStick Button</div>
								<div class="buttonConfig" id="RStick"></div><br>
								<div class="actionText">L</div>
								<div class="buttonConfig" id="L"></div><br>
								<div class="actionText">ZL</div>
								<div class="buttonConfig" id="ZL"></div><br>
								<div class="actionText">R</div>
								<div class="buttonConfig" id="R"></div><br>
								<div class="actionText">ZR</div>
								<div class="buttonConfig" id="ZR"></div><br>
								<div class="actionText">Minus</div>
								<div class="buttonConfig" id="Minus"></div><br>
								<input type="button" id="resetControls" value="Reset" />
							</div>
						</div>

						<!-- 						<div class="tab-pane" id="soundSettingsFrame">
							<div id="volumeConfig">
								<div class="actionText">Master Volume</div>
								<div class="buttonConfig" title="forward" id="forward"></div><br>
							</div>

							<input id="ex1" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="50" />

							sound stuff
						</div>

						<div class="tab-pane" id="videoSettingsFrame">
							video stuff
						</div> -->

					</div>

				</div>
			</div>
		</div>
	</div>
	<!-- END OF SETTINGS WINDOW ------------------------------------------- -->

</body>

</html>

<script>
	var globalEventTimer = false;
	var keyboardTimer;
	var gamepadTimer;
	var touchTimer;

	var keyboardLayout = {};
	keyboardLayout.LYU = "W";
	keyboardLayout.LYD = "S";
	keyboardLayout.LXL = "A";
	keyboardLayout.LXR = "D";
	keyboardLayout.RYU = "I";
	keyboardLayout.RYD = "K";
	keyboardLayout.RXL = "J";
	keyboardLayout.RXR = "L";
	keyboardLayout.A = "right";
	keyboardLayout.B = "down";
	keyboardLayout.X = "up";
	keyboardLayout.Y = "left";
	keyboardLayout.DUP = "T";
	keyboardLayout.DDown = "G";
	keyboardLayout.DLeft = "F";
	keyboardLayout.DRight = "H";
	keyboardLayout.LStick = "R";
	keyboardLayout.RStick = "Y";
	keyboardLayout.L = "U";
	keyboardLayout.L = "U";
	keyboardLayout.ZL = "Q";
	keyboardLayout.R = "O";
	keyboardLayout.ZR = "E";
	keyboardLayout.Minus = "-";

	function directedGetImage(user, quality) {
		var data = {};
		data.user = user;
		data.quality = quality;
		socket.emit("directedGetImage", data);
	}


	// all:

	$("#getImageForm").on("submit", function(event) {
		event.preventDefault();
		socket.emit("getImage");
	});



	// directed:


	$("#directedGetImageForm").on("submit", function(event) {
		event.preventDefault();

		//var user = $("#directedGetImageUser").val();
		var user = $("#directedTarget").val();
		directedGetImage(user);
	});



	// other:

	//   $("#getNamesform").on("submit", function(event) {
	//     event.preventDefault();
	//     socket.emit("getNames");
	//   });

	$("#listAllForm").on("submit", function(event) {
		event.preventDefault();
		socket.emit("listAll");
	});

	socket.on("names", function(data) {
		$("#namesList").empty();
		for (var i = 0; i < data.length; i++) {
			var div = $("<div class='list-group-item'>" + data[i] + "</div>");
			$("#namesList").append(div);

			$("#namesList").last().on("click", function(event) {
				var name = $(event.target).text();
				$("#directedTarget").val(name);
				//directedGetImage(name);
			});
		}
	});


	function getMeta(url, callback) {
		var img = new Image();
		img.src = url;
		img.onload = function() {
			callback(this.width, this.height);
		}
	}


	// 	socket.on("viewImage", function(data) {


	// 		var src = "data:image/jpeg;base64," + data.src;
	// 		if(src == "data:image/jpeg;base64,") {
	// 			socket.emit("restart");
	// 		}

	// 		var image = new Image();
	// 		image.src = src;
	// 		image.style = "width: 100%; height: auto;";
	// 		image.class = "img-thumbnail";
	// 		//image.style = "width:120%; height:auto;";
	// 		image.id = "screenshot";

	// // 		$("#picture").empty();
	// // 		$("#picture").append(image);

	// 		$("#screenshot")[0].replaceWith(image);
	// 	});

	function getNewestImage() {
		$("#screen").load("/8110/img/ #screenshot");

		// 		$("#video").src = $("#screenshot").src;
		// 		$("#video").attr("src", $("#screenshot").attr("src"));

		var fps = parseInt($("#fpsSlider").val());
		var timeToSleep = 1000 / fps;
		setTimeout(getNewestImage, timeToSleep);
	}

	getNewestImage();


	setInterval(function() {
		globalEventTimer = false;
	}, 100);

	/*    IP */
	// 	setInterval(function() {
	// 		$.getJSON("https://jsonip.com?callback=?", function (data) {
	// 		//console.log(data.ip);
	// 			socket.emit("registerIP", {ip: data.ip});
	// 		});
	// 	}, 5000);

	//   	$("#setUsernameForm").on("submit", function() {
	// 		event.preventDefault();
	// 		var name = $("#usernameInput").val();

	// 		$.getJSON("https://jsonip.com?callback=?", function (data) {
	// 			//console.log(data.ip);
	// 			socket.emit("registerIP", {ip: data.ip});
	// 			socket.emit("registerUsername", name);
	// 		});

	// 		$("#usernameInput").val("");
	// 		return false;
	// 	});

	/*    CHAT */
	$("#chatForm").on("submit", function() {
		event.preventDefault();
		var msg = $("#msgInput").val();
		socket.emit("chat message", msg);
		$("#msgInput").val("");
		return false;
	});

	socket.on("chat message", function(msg) {
		var newMessage = $('<li>').text(msg);
		$("#messageList").append(newMessage);
		newMessage[0].scrollIntoView(false);
	});

	socket.on("current player", function(data) {
		$("#currentPlayer").text("Current Player: " + data);
	});

	// 	var $iframe = $("#twitchchat").contents();
	// 	$iframe.find("span[data-a-target='edit-display-name']");

	function updateImage() {
		var user = $("#directedTarget").val();
		var quality = $("#directedQuality").val();
		directedGetImage(user, quality);
		setTimeout(updateImage, $("#directedUpdateRate").val());
	}


	/* CONTROLLER STUFF */

	var gamepadCounter = 0;

	controller = {};
	controller.btns = {};
	controller.LStick = {
		x: 128,
		y: 128
	};
	controller.RStick = {
		x: 128,
		y: 128
	};

	controller.btns.up = false;
	controller.btns.down = false;
	controller.btns.left = false;
	controller.btns.right = false;
	controller.btns.stick_button = false;
	controller.btns.l = false;
	controller.btns.zl = false;
	controller.btns.minus = false;
	controller.btns.capture = false;

	controller.btns.a = false;
	controller.btns.b = false;
	controller.btns.x = false;
	controller.btns.y = false;
	controller.btns.stick_button2 = false;
	controller.btns.r = false;
	controller.btns.zr = false;
	controller.btns.plus = false;
	controller.btns.home = false;

	controller.reset = function() {
		for (let prop in controller.btns) {
			controller.btns[prop] = false;
		}
		controller.LStick.x = 128;
		controller.LStick.y = 128;
		controller.RStick.x = 128;
		controller.RStick.y = 128;
	}

	var oldControllerState = "";


	function sendKeyboardInputs() {

		if (!document.getElementById("keyboardController").checked) {
			return;
		}
		var authCookie = getCookie("TwitchPlaysNintendoSwitch");
		if (authCookie == null) {
			$("#keyboardController").prop("checked", false);
			alert("You need to connect to twitch!");
			return;
		}


		controller.reset();

		if (key.isPressed(keyboardLayout.LYU)) {
			controller.LStick.y = 255;
		}
		if (key.isPressed(keyboardLayout.LYD)) {
			controller.LStick.y = 0;
		}
		if (key.isPressed(keyboardLayout.LXL)) {
			controller.LStick.x = 0;
		}
		if (key.isPressed(keyboardLayout.LXR)) {
			controller.LStick.x = 255;
		}

		if (key.isPressed(keyboardLayout.X)) {
			controller.btns.x = 1;
		}
		if (key.isPressed(keyboardLayout.B)) {
			controller.btns.b = 1;
		}
		if (key.isPressed(keyboardLayout.Y)) {
			controller.btns.y = 1;
		}
		if (key.isPressed(keyboardLayout.A)) {
			controller.btns.a = 1;
		}

		if (key.isPressed(keyboardLayout.DUp)) {
			controller.btns.up = 1;
		}
		if (key.isPressed(keyboardLayout.DDown)) {
			controller.btns.down = 1;
		}
		if (key.isPressed(keyboardLayout.DLeft)) {
			controller.btns.left = 1;
		}
		if (key.isPressed(keyboardLayout.DRight)) {
			controller.btns.right = 1;
		}

		//     if(key.isPressed("space")) {
		//       controller.btns.b = true;
		//     }


		if (key.isPressed(keyboardLayout.RYU)) {
			controller.RStick.y = 255;
		}
		if (key.isPressed(keyboardLayout.RYD)) {
			controller.RStick.y = 0;
		}
		if (key.isPressed(keyboardLayout.RXL)) {
			controller.RStick.x = 0;
		}
		if (key.isPressed(keyboardLayout.RXR)) {
			controller.RStick.x = 255;
		}

		if (key.isPressed(keyboardLayout.Minus)) {
			controller.btns.minus = true;
		}

		// 		if (key.isPressed("space")) {
		// 			controller.btns.zr = true;
		// 		}


		if (key.isPressed(keyboardLayout.L)) {
			controller.btns.l = 1;
		}
		if (key.isPressed(keyboardLayout.R)) {
			controller.btns.r = 1;
		}

		if (key.isPressed(keyboardLayout.ZL)) {
			controller.btns.zl = 1;
		}
		if (key.isPressed(keyboardLayout.ZR)) {
			controller.btns.zr = 1;
		}

		if (key.isPressed(keyboardLayout.LStick)) {
			controller.btns.stick_button = 1;
		}
		if (key.isPressed(keyboardLayout.RStick)) {
			controller.btns.stick_button2 = 1;
		}



		// 		if (key.isPressed("C")) {
		// 			socket.emit("chat message", "cap bounce");
		// 		}



		let newControllerState = "";

		if (controller.btns.up == 1 && controller.btns.left == 1) {
			newControllerState += "7";
		} else if (controller.btns.up && controller.btns.right == 1) {
			newControllerState += "1";
		} else if (controller.btns.down == 1 && controller.btns.left == 1) {
			newControllerState += "5";
		} else if (controller.btns.down == 1 && controller.btns.right == 1) {
			newControllerState += "3";
		} else if (controller.btns.up == 1) {
			newControllerState += "0";
		} else if (controller.btns.down == 1) {
			newControllerState += "4";
		} else if (controller.btns.left == 1) {
			newControllerState += "6";
		} else if (controller.btns.right == 1) {
			newControllerState += "2";
		} else {
			newControllerState += "8";
		}

		newControllerState += controller.btns.stick_button == 1 ? "1" : "0";
		newControllerState += controller.btns.l == 1 ? "1" : "0";
		newControllerState += controller.btns.zl == 1 ? "1" : "0";
		newControllerState += controller.btns.minus == 1 ? "1" : "0";
		newControllerState += controller.btns.capture == 1 ? "1" : "0";

		newControllerState += controller.btns.a == 1 ? "1" : "0";
		newControllerState += controller.btns.b == 1 ? "1" : "0";
		newControllerState += controller.btns.x == 1 ? "1" : "0";
		newControllerState += controller.btns.y == 1 ? "1" : "0";
		newControllerState += controller.btns.stick_button2 == 1 ? "1" : "0";
		newControllerState += controller.btns.r == 1 ? "1" : "0";
		newControllerState += controller.btns.zr == 1 ? "1" : "0";
		newControllerState += controller.btns.plus == 1 ? "1" : "0";
		newControllerState += controller.btns.home == 1 ? "1" : "0";


		var LX = controller.LStick.x;
		var LY = controller.LStick.y;
		var RX = controller.RStick.x;
		var RY = controller.RStick.y;

		newControllerState += " " + LX + " " + LY + " " + RX + " " + RY;


		if (newControllerState == oldControllerState) {
			return;
		} else {
			oldControllerState = newControllerState;
		}
		console.log(newControllerState);
		socket.emit("sendControllerState", newControllerState);
	}



	/* prevent arrow key scrolling */
	window.addEventListener("keydown", function(e) {
		// space and arrow keys
		if ([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
			e.preventDefault();
		}
	}, false);


	/* GAMEPAD API */

	// 	var gamepadAPI = {
	// 		controller: {},
	// 		turbo: false,
	// 		connect: function(evt) {
	// 			gamepadAPI.controller = evt.gamepad;
	// 			gamepadAPI.turbo = true;
	// 			console.log('Gamepad connected.');
	// 		},
	// 		disconnect: function(evt) {
	// 			gamepadAPI.turbo = false;
	// 			delete gamepadAPI.controller;
	// 			console.log('Gamepad disconnected.');
	// 		},
	// 		update: function() {
	// 			// clear the buttons cache
	// 			gamepadAPI.buttonsCache = [];
	// 			// move the buttons status from the previous frame to the cache
	// 			for(var k=0; k<gamepadAPI.buttonsStatus.length; k++) {
	// 				gamepadAPI.buttonsCache[k] = gamepadAPI.buttonsStatus[k];
	// 			}
	// 			// clear the buttons status
	// 			gamepadAPI.buttonsStatus = [];
	// 			// get the gamepad object
	// 			var c = gamepadAPI.controller || {};

	// 			// loop through buttons and push the pressed ones to the array
	// 			var pressed = [];
	// 			if(c.buttons) {
	// 				for(var b=0,t=c.buttons.length; b<t; b++) {
	// 					if(c.buttons[b].pressed) {
	// 						pressed.push(gamepadAPI.buttons[b]);
	// 					}
	// 				}
	// 			}
	// 			// loop through axes and push their values to the array
	// 			var axes = [];
	// 			if(c.axes) {
	// 				for(var a=0, x=c.axes.length; a<x; a++) {
	// 					axes.push(c.axes[a].toFixed(2));
	// 				}
	// 			}
	// 			// assign received values
	// 			gamepadAPI.axesStatus = axes;
	// 			gamepadAPI.buttonsStatus = pressed;
	// 			// return buttons for debugging purposes
	// 			return pressed;
	// 		},
	// 		buttonPressed: function(button, hold) {
	// 			var newPress = false;
	// 			// loop through pressed buttons
	// 			for(var i=0,s=gamepadAPI.buttonsStatus.length; i<s; i++) {
	// 				// if we found the button we're looking for...
	// 				if(gamepadAPI.buttonsStatus[i] == button) {
	// 					// set the boolean variable to true
	// 					newPress = true;
	// 					// if we want to check the single press
	// 					if(!hold) {
	// 						// loop through the cached states from the previous frame
	// 						for(var j=0,p=gamepadAPI.buttonsCache.length; j<p; j++) {
	// 							// if the button was already pressed, ignore new press
	// 							if(gamepadAPI.buttonsCache[j] == button) {
	// 								newPress = false;
	// 							}
	// 						}
	// 					}
	// 				}
	// 			}
	// 			return newPress;
	// 		},
	// 		buttons: [],
	// 		buttonsCache: [],
	// 		buttonsStatus: [],
	// 		axesStatus: []
	// 	};
	// 	window.addEventListener("gamepadconnected", gamepadAPI.connect);
	// 	window.addEventListener("gamepaddisconnected", gamepadAPI.disconnect);


	const gamepad = new Gamepad();

	gamepad.on('connect', e => {
		console.log(`controller ${e.index} connected!`);
		gamepadCounter += 1;
		window.clearInterval(keyboardTimer);
	});

	gamepad.on('disconnect', e => {
		console.log(`controller ${e.index} disconnected!`);
		gamepadCounter -= 1;
		keyboardTimer = setInterval(sendKeyboardInputs, 10);
	});

	gamepad.on('press', 'button_1', e => {
		controller.btns.b = 1;
	});
	gamepad.on('release', 'button_1', e => {
		controller.btns.b = 0;
	});

	gamepad.on('press', 'button_2', e => {
		controller.btns.a = 1;
	});
	gamepad.on('release', 'button_2', e => {
		controller.btns.a = 0;
	});

	gamepad.on('press', 'button_3', e => {
		controller.btns.y = 1;
	});
	gamepad.on('release', 'button_3', e => {
		controller.btns.y = 0;
	});

	gamepad.on('press', 'button_4', e => {
		controller.btns.x = 1;
	});
	gamepad.on('release', 'button_4', e => {
		controller.btns.x = 0;
	});


	gamepad.on('press', 'shoulder_top_left', e => {
		controller.btns.l = 1;
	});
	gamepad.on('release', 'shoulder_top_left', e => {
		controller.btns.l = 0;
	});

	gamepad.on('press', 'shoulder_top_right', e => {
		controller.btns.r = 1;
	});
	gamepad.on('release', 'shoulder_top_right', e => {
		controller.btns.r = 0;
	});

	gamepad.on('press', 'shoulder_bottom_left', e => {
		controller.btns.zl = 1;
	});
	gamepad.on('release', 'shoulder_bottom_left', e => {
		controller.btns.zl = 0;
	});

	gamepad.on('press', 'shoulder_bottom_right', e => {
		controller.btns.zr = 1;
	});
	gamepad.on('release', 'shoulder_bottom_right', e => {
		controller.btns.zr = 0;
	});

	gamepad.on('press', 'select', e => {
		controller.btns.minus = 1;
	});
	gamepad.on('release', 'select', e => {
		controller.btns.minus = 0;
	});



	gamepad.on('press', 'd_pad_up', e => {
		controller.btns.up = 1;
	});
	gamepad.on('release', 'd_pad_up', e => {
		controller.btns.up = 0;
	});

	gamepad.on('press', 'd_pad_down', e => {
		controller.btns.down = 1;
	});
	gamepad.on('release', 'd_pad_down', e => {
		controller.btns.down = 0;
	});

	gamepad.on('press', 'd_pad_left', e => {
		controller.btns.left = 1;
	});
	gamepad.on('release', 'd_pad_left', e => {
		controller.btns.left = 0;
	});

	gamepad.on('press', 'd_pad_right', e => {
		controller.btns.right = 1;
	});
	gamepad.on('release', 'd_pad_right', e => {
		controller.btns.right = 0;
	});

	gamepad.on('hold', 'stick_axis_left', e => {
		var x = e.value[0];
		var y = e.value[1];
		x = (x / 2) + 0.5;
		y = (-y / 2) + 0.5;
		x *= 255;
		y *= 255;
		controller.LStick.x = parseInt(x);
		controller.LStick.y = parseInt(y);
		var thresh = parseInt($("#threshold").text());
		if (Math.abs(128 - controller.LStick.x) < thresh) {
			controller.LStick.x = 128;
		}
		if (Math.abs(128 - controller.LStick.y) < thresh) {
			controller.LStick.y = 128;
		}
	});
	gamepad.on('press', 'stick_axis_left', e => {
		var x = e.value[0];
		var y = e.value[1];
		x = (x / 2) + 0.5;
		y = (-y / 2) + 0.5;
		x *= 255;
		y *= 255;
		controller.LStick.x = parseInt(x);
		controller.LStick.y = parseInt(y);
		var thresh = parseInt($("#threshold").text());
		if (Math.abs(128 - controller.LStick.x) < thresh) {
			controller.LStick.x = 128;
		}
		if (Math.abs(128 - controller.LStick.y) < thresh) {
			controller.LStick.y = 128;
		}
	});
	gamepad.on('release', 'stick_axis_left', e => {
		var x = e.value[0];
		var y = e.value[1];
		x = (x / 2) + 0.5;
		y = (-y / 2) + 0.5;
		x *= 255;
		y *= 255;
		controller.LStick.x = parseInt(x);
		controller.LStick.y = parseInt(y);
		var thresh = parseInt($("#threshold").text());
		if (Math.abs(128 - controller.LStick.x) < thresh) {
			controller.LStick.x = 128;
		}
		if (Math.abs(128 - controller.LStick.y) < thresh) {
			controller.LStick.y = 128;
		}
	});
	gamepad.on('hold', 'stick_axis_right', e => {
		var x = e.value[0];
		var y = e.value[1];
		x = (x / 2) + 0.5;
		y = (-y / 2) + 0.5;
		x *= 255;
		y *= 255;
		controller.RStick.x = parseInt(x);
		controller.RStick.y = parseInt(y);
		var thresh = parseInt($("#threshold").text());
		if (Math.abs(128 - controller.RStick.x) < thresh) {
			controller.RStick.x = 128;
		}
		if (Math.abs(128 - controller.RStick.y) < thresh) {
			controller.RStick.y = 128;
		}
	});
	gamepad.on('press', 'stick_axis_right', e => {
		var x = e.value[0];
		var y = e.value[1];
		x = (x / 2) + 0.5;
		y = (-y / 2) + 0.5;
		x *= 255;
		y *= 255;
		controller.RStick.x = parseInt(x);
		controller.RStick.y = parseInt(y);
		var thresh = parseInt($("#threshold").text());
		if (Math.abs(128 - controller.RStick.x) < thresh) {
			controller.RStick.x = 128;
		}
		if (Math.abs(128 - controller.RStick.y) < thresh) {
			controller.RStick.y = 128;
		}
	});
	gamepad.on('release', 'stick_axis_right', e => {
		var x = e.value[0];
		var y = e.value[1];
		x = (x / 2) + 0.5;
		y = (-y / 2) + 0.5;
		x *= 255;
		y *= 255;
		controller.RStick.x = parseInt(x);
		controller.RStick.y = parseInt(y);
		var thresh = parseInt($("#threshold").text());
		if (Math.abs(128 - controller.RStick.x) < thresh) {
			controller.RStick.x = 128;
		}
		if (Math.abs(128 - controller.RStick.y) < thresh) {
			controller.RStick.y = 128;
		}
	});

	gamepad.on('press', 'stick_button_left', e => {
		controller.btns.stick_button = 1;
	});
	gamepad.on('release', 'stick_button_left', e => {
		controller.btns.stick_button = 0;
	});
	gamepad.on('press', 'stick_button_right', e => {
		controller.btns.stick_button2 = 1;
	});
	gamepad.on('release', 'stick_button_right', e => {
		controller.btns.stick_button2 = 0;
	});


	function sendGamePadInputs() {

		if (!document.getElementById("keyboardController").checked) {
			return;
		}
		var authCookie = getCookie("TwitchPlaysNintendoSwitch");
		if (authCookie == null) {
			$("#keyboardController").prop("checked", false);
			alert("You need to connect to twitch!");
			return;
		}
		//controller.reset();

		let newControllerState = "";

		if (controller.btns.up == 1 && controller.btns.left == 1) {
			newControllerState += "7";
		} else if (controller.btns.up && controller.btns.right == 1) {
			newControllerState += "1";
		} else if (controller.btns.down == 1 && controller.btns.left == 1) {
			newControllerState += "5";
		} else if (controller.btns.down == 1 && controller.btns.right == 1) {
			newControllerState += "3";
		} else if (controller.btns.up == 1) {
			newControllerState += "0";
		} else if (controller.btns.down == 1) {
			newControllerState += "4";
		} else if (controller.btns.left == 1) {
			newControllerState += "6";
		} else if (controller.btns.right == 1) {
			newControllerState += "2";
		} else {
			newControllerState += "8";
		}

		newControllerState += controller.btns.stick_button == 1 ? "1" : "0";
		newControllerState += controller.btns.l == 1 ? "1" : "0";
		newControllerState += controller.btns.zl == 1 ? "1" : "0";
		newControllerState += controller.btns.minus == 1 ? "1" : "0";
		newControllerState += controller.btns.capture == 1 ? "1" : "0";

		newControllerState += controller.btns.a == 1 ? "1" : "0";
		newControllerState += controller.btns.b == 1 ? "1" : "0";
		newControllerState += controller.btns.x == 1 ? "1" : "0";
		newControllerState += controller.btns.y == 1 ? "1" : "0";
		newControllerState += controller.btns.stick_button2 == 1 ? "1" : "0";
		newControllerState += controller.btns.r == 1 ? "1" : "0";
		newControllerState += controller.btns.zr == 1 ? "1" : "0";
		newControllerState += controller.btns.plus == 1 ? "1" : "0";
		newControllerState += controller.btns.home == 1 ? "1" : "0";


		var LX = controller.LStick.x;
		var LY = controller.LStick.y;
		var RX = controller.RStick.x;
		var RY = controller.RStick.y;

		newControllerState += " " + LX + " " + LY + " " + RX + " " + RY;

		if (newControllerState == oldControllerState) {
			return;
		} else {
			oldControllerState = newControllerState;
		}
		console.log(newControllerState);
		socket.emit("sendControllerState", newControllerState);
	}











	/* KEYBOARD CONFIG */


	// Get stored preferences
	// 	localforage.getItem('keyboardLayout').then(function(value) {
	// 		// If they exist, write them
	// 		if (value) {
	// 			keyboardLayout = value;
	// 		}
	// 		// Store the preferences (so that the default values get stored)
	// 		localforage.setItem('keyboardLayout', keyboardLayout);


	// 		// Update the keyboard layout settings window to reflect the stored settings, not the default ones
	// 		for (var i = 0; i < $(".buttonConfig").length; i++) {
	// 			var div = $(".buttonConfig")[i];
	// 			var assignedKey = keyboardLayout[div.id];
	// 			$("#" + div.id).html(String.fromCharCode(assignedKey).toLowerCase());
	// 		}
	// 	});

	//change document to #keyboardLayoutConfig using <tabindex="0">
	$(".buttonConfig").on('click', function(e) {
		$(document).off("keydown");
		//window.addEventListener("keydown", handleKey, false);
		$(document).on("keydown", function(e2) {
			console.log(e2.key);
			var keys = [];
			for (var i in keyboardLayout) {
				keys.push(keyboardLayout[i]);
			}
			//var values = Object.values(preferences.keyboard.layout);
			if (keys.indexOf(e2.key) == -1) {
				$("#" + e.target.id).html(String.fromCharCode(e2.which));
				keyboardLayout[e.target.id] = e2.key;
				localforage.setItem('keyboardLayout', keyboardLayout);

				$(document).off("keydown");
				//window.addEventListener("keydown", handleKey, false);
			} else {
				$("#" + e.target.id).animate({
					backgroundColor: "#AC3333"
				}, 'fast');
				setTimeout(function() {
					$("#" + e.target.id).animate({
						backgroundColor: "#888"
					}, 'slow');
				}, 100);
			}
		});
	});
	$("#keyboardLayoutConfig").on('click', function(e) {
		//console.log(e.target);
		var isButton = e.target.classList[0] == "buttonConfig";
		if (!isButton) {
			$(document).off("keydown");
			// 			window.addEventListener("keydown", handleKey, false);
		}
	});








	/* TOUCH CONTROLS */

	var s = function(sel) {
		return document.querySelector(sel);
	};
	var sId = function(sel) {
		return document.getElementById(sel);
	};
	var removeClass = function(el, clss) {
		el.className = el.className.replace(new RegExp('\\b' + clss + ' ?\\b', 'g'), '');
	}
	var joysticks = {
		leftStick: {
			zone: document.querySelector('#leftStick'),
			mode: 'semi',
			catchDistance: 150,
			color: 'red',
			multitouch: true,
		},
		rightStick: {
			zone: document.querySelector('#rightStick'),
			mode: 'semi',
			catchDistance: 150,
			color: 'blue',
			multitouch: true,
		},
		
	};
	
	var leftStick;
	var rightStick;
	
	createJoysticks('static');

	function bindJoysticks() {
		leftStick.on("start", function(evt, data) {
			var pos = data.frontPosition;
			pos.x = parseInt(((pos.x + 50)/100)*255);
			pos.y = parseInt(((pos.y + 50)/100)*255);
			pos.y = 255 - pos.y;
			controller.LStick.x = pos.x;
			controller.LStick.y = pos.y;
		}).on("end", function(evt, data) {
			controller.LStick.x = 128;
			controller.LStick.y = 128;
		}).on("move", function(evt, data) {
			var pos = data.instance.frontPosition;
			pos.x = parseInt(((pos.x + 50)/100)*255);
			pos.y = parseInt(((pos.y + 50)/100)*255);
			pos.y = 255 - pos.y;
			controller.LStick.x = pos.x;
			controller.LStick.y = pos.y;
		})
		
		rightStick.on("start", function(evt, data) {
			var pos = data.frontPosition;
			pos.x = parseInt(((pos.x + 50)/100)*255);
			pos.y = parseInt(((pos.y + 50)/100)*255);
			pos.y = 255 - pos.y;
			controller.RStick.x = pos.x;
			controller.RStick.y = pos.y;
		}).on("end", function(evt, data) {
			controller.RStick.x = 128;
			controller.RStick.y = 128;
		}).on("move", function(evt, data) {
			var pos = data.instance.frontPosition;
			pos.x = parseInt(((pos.x + 50)/100)*255);
			pos.y = parseInt(((pos.y + 50)/100)*255);
			pos.y = 255 - pos.y;
			controller.RStick.x = pos.x;
			controller.RStick.y = pos.y;
		})
	}

	function createJoysticks(evt) {
// 		var type = typeof evt === 'string' ? evt : evt.target.getAttribute('data-type');
		//s('.zone.' + type).className += ' active';
		leftStick = nipplejs.create(joysticks["leftStick"]);
		rightStick = nipplejs.create(joysticks["rightStick"]);
		bindJoysticks();
	}
	
	
	function sendTouchInputs() {

		if (!document.getElementById("touchControlsCheckbox").checked) {
			return;
		}
		var authCookie = getCookie("TwitchPlaysNintendoSwitch");
		if (authCookie == null) {
			$("#touchControlsCheckbox").prop("checked", false);
			alert("You need to connect to twitch!");
			return;
		}
		//controller.reset();

		let newControllerState = "";

		if (controller.btns.up == 1 && controller.btns.left == 1) {
			newControllerState += "7";
		} else if (controller.btns.up && controller.btns.right == 1) {
			newControllerState += "1";
		} else if (controller.btns.down == 1 && controller.btns.left == 1) {
			newControllerState += "5";
		} else if (controller.btns.down == 1 && controller.btns.right == 1) {
			newControllerState += "3";
		} else if (controller.btns.up == 1) {
			newControllerState += "0";
		} else if (controller.btns.down == 1) {
			newControllerState += "4";
		} else if (controller.btns.left == 1) {
			newControllerState += "6";
		} else if (controller.btns.right == 1) {
			newControllerState += "2";
		} else {
			newControllerState += "8";
		}

		newControllerState += controller.btns.stick_button == 1 ? "1" : "0";
		newControllerState += controller.btns.l == 1 ? "1" : "0";
		newControllerState += controller.btns.zl == 1 ? "1" : "0";
		newControllerState += controller.btns.minus == 1 ? "1" : "0";
		newControllerState += controller.btns.capture == 1 ? "1" : "0";

		newControllerState += controller.btns.a == 1 ? "1" : "0";
		newControllerState += controller.btns.b == 1 ? "1" : "0";
		newControllerState += controller.btns.x == 1 ? "1" : "0";
		newControllerState += controller.btns.y == 1 ? "1" : "0";
		newControllerState += controller.btns.stick_button2 == 1 ? "1" : "0";
		newControllerState += controller.btns.r == 1 ? "1" : "0";
		newControllerState += controller.btns.zr == 1 ? "1" : "0";
		newControllerState += controller.btns.plus == 1 ? "1" : "0";
		newControllerState += controller.btns.home == 1 ? "1" : "0";


		var LX = controller.LStick.x;
		var LY = controller.LStick.y;
		var RX = controller.RStick.x;
		var RY = controller.RStick.y;

		newControllerState += " " + LX + " " + LY + " " + RX + " " + RY;

		if (newControllerState == oldControllerState) {
			return;
		} else {
			oldControllerState = newControllerState;
		}
		console.log(newControllerState);
		socket.emit("sendControllerState", newControllerState);
	}
	
	$("#touchControls")[0].style.display = "none";
    $("#touchControlsCheckbox").on("click", function() {
		if($(this).is(":checked")) {
			$("#touchControls")[0].style.display = "";
		} else {
			$("#touchControls")[0].style.display = "none";
		}
    });
	
	keyboardTimer = setInterval(sendKeyboardInputs, 10);
	gamepadTimer = setInterval(sendGamePadInputs, 10);
	touchTimer = setInterval(sendTouchInputs, 10);
	
	
	
	
	
	/* AUTH  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ */
	$("#authenticateButton").on('click', function(event) {
		setCookie("AttemptedAuth", 1, 60);
	});


	var authCookie = getCookie("TwitchPlaysNintendoSwitch");
	var attemptedAuth = getCookie("AttemptedAuth");

	if (attemptedAuth && !authCookie) {
		window.location.href = "https://twitchplaysnintendoswitch.com/8110/";
	}
	if (authCookie != null) {
		socket.emit("registerUsername", authCookie);
		$("#authenticateButton").remove();
	}

	setInterval(function() {
		if (authCookie != null) {
			socket.emit("registerUsername", authCookie);
			$("#authenticateButton").remove();
		}
	}, 1000 * 60);
	
	
	
	/* STREAM SETTINGS @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/
	
	$("#qualitySlider").on("input", function(event) {
		var quality = this.value;
		$("#quality").text(quality);
		socket.emit("setQuality", parseInt(quality));
	})
	$("#scaleSlider").on("input", function(event) {
		var scale = this.value;
		$("#scale").text(scale);
		socket.emit("setScale", parseInt(scale));
	})
	$("#fpsSlider").on("input", function(event) {
		var fps = this.value;
		$("#fps").text(fps);
		// 		socket.emit("setFPS", parseInt(fps));
	})
	$("#thresholdSlider").on("input", function(event) {
		var threshold = this.value;
		$("#threshold").text(threshold);
	})

	socket.on("setQuality", function(data) {
		$("#quality").text(data);
		$("#qualitySlider").val(data);
	});
	socket.on("setScale", function(data) {
		$("#scale").text(data);
		$("#scaleSlider").val(data);
	});
	socket.on("setFPS", function(data) {
		$("#fps").text(data);
		$("#fpsSlider").val(data);
	});
</script>