<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript" src="keymaster.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />
<link rel="stylesheet" href="css/stylesheet.css">

<script>
	var socket;
	socket = io('https://fosse.co', {
		path: '/8110/socket.io'
	});
	// 	socket = io('fosse.co:8080');
	//socket = io("http://fosse.co:80");
	//socket = io("http://fosse.co:80/8110/socket.io");
</script>


<html>


<style>
</style>

<body>

	<div id="metaContainer">

		<div id="container" class="container">

			<!-- 		<div id="console">
			
			<br> target:
			<br>
			<input id="directedTarget" type="text" placeholder="name" value="Matt">
			<br> update rate:
			<br>
			<input id="directedUpdateRate" type="number" value="100">
			<br> quality:
			<br>
			<input id="directedQuality" type="number" value="10">
      
      
			<br>
			<form id="getImageForm">
				<button>Get Image</button>
			</form>

			<br>
			<form id="listAllForm">
				<button>List All Connected Clients:</button>
			</form>

			<div id="namesList" class="list-group">
			</div>

		</div> -->



			<div id="picture" class="one" oncontextmenu="return false">
				
				<image id="screenshot"></image>

				<div class="checkbox">
					<label class="checkbox-bootstrap checkbox-lg">                                        
					<input id="keyboardController" type="checkbox">             
					<span class="checkbox-placeholder"></span>           
					Control with keyboard
				</label>
				</div>

				<div id="controls">

					<ul>
						Controls:
						<li>WASD = Left Stick</li>
						<li>IJKL = Right Stick</li>
						<li>F = DPad Down</li>
						<li>O = Minus</li>
						<li>Arrow Keys = A/B/X/Y</li>
					</ul>
				</div>
			</div>

			<div id="chat" class="two">
				Chat
				<div id="messages">
					<ul id="messageList"></ul>
				</div>

				<form id="chatForm" class="form-inline">
<!-- 					<div class="form-group"> -->
						<input id="msgInput" class="form-control" type="text" autocomplete="off" />
						<button id="sendButton" class="btn btn-primary" type="submit">Send</button>
<!-- 					</div> -->
				</form>
			</div>

		</div>
		
		
<!-- 	<div class="checkbox">
		<label class="checkbox-bootstrap checkbox-lg">                                        
		<input id="keyboardController" type="checkbox">             
		<span class="checkbox-placeholder"></span>           
		Control with keyboard
	</label>
	</div>

	<div id="controls">

		<ul>
			Controls:
			<li>WASD = Left Stick</li>
			<li>IJKL = Right Stick</li>
			<li>F = DPad Down</li>
			<li>O = Minus</li>
			<li>Arrow Keys = A/B/X/Y</li>
		</ul>
	</div> -->



	</div>

</body>

</html>

<script>
	var globalEventTimer = false;

	function directedGetImage(user, quality) {
		var data = {};
		data.user = user;
		data.quality = quality;
		socket.emit("directedGetImage", data);
	}


	// all:

	$("#getImageForm").on("submit", function(event) {
		event.preventDefault();
		socket.emit("getImage");
	});



	// directed:


	$("#directedGetImageForm").on("submit", function(event) {
		event.preventDefault();

		//var user = $("#directedGetImageUser").val();
		var user = $("#directedTarget").val();
		directedGetImage(user);
	});



	// other:

	//   $("#getNamesform").on("submit", function(event) {
	//     event.preventDefault();
	//     socket.emit("getNames");
	//   });

	$("#listAllForm").on("submit", function(event) {
		event.preventDefault();
		socket.emit("listAll");
	});

	socket.on("names", function(data) {
		$("#namesList").empty();
		for (var i = 0; i < data.length; i++) {
			var div = $("<div class='list-group-item'>" + data[i] + "</div>");
			$("#namesList").append(div);

			$("#namesList").last().on("click", function(event) {
				var name = $(event.target).text();
				$("#directedTarget").val(name);
				//directedGetImage(name);
			});
		}
	});


	function getMeta(url, callback) {
		var img = new Image();
		img.src = url;
		img.onload = function() {
			callback(this.width, this.height);
		}
	}


	socket.on("viewImage", function(data) {

		var src = "data:image/jpeg;base64," + data.src;
		if(src == "data:image/jpeg;base64,") {
			socket.emit("restart");
		}

		var image = new Image();
		image.src = src;
		image.style = "max-width:100%; height:auto;";
		//image.style = "width:120%; height:auto;";
		image.id = "screenshot";
		
// 		$("#picture").empty();
// 		$("#picture").append(image);

		$("#screenshot")[0].replaceWith(image);
	});


	setInterval(function() {
		globalEventTimer = false;
	}, 100);
	
	
	
	/*    CHAT */
	$("#chatForm").on("submit", function() {
		event.preventDefault();
		var msg = $("#msgInput").val();
		socket.emit("chat message", msg);
		$("#msgInput").val("");
		return false;
	});
	
	socket.on("chat message", function(msg) {
		var newMessage = $('<li>').text(msg);
		$("#messageList").append(newMessage);
		newMessage[0].scrollIntoView(false);
	});

	function updateImage() {
		var user = $("#directedTarget").val();
		var quality = $("#directedQuality").val();
		directedGetImage(user, quality);
		setTimeout(updateImage, $("#directedUpdateRate").val());
	}

	controller = {};
	controller.btns = {};
	controller.LStick = {
		x: 128,
		y: 128
	};
	controller.RStick = {
		x: 128,
		y: 128
	};

	controller.btns.up = false;
	controller.btns.down = false;
	controller.btns.left = false;
	controller.btns.right = false;
	controller.btns.stick_button = false;
	controller.btns.l = false;
	controller.btns.zl = false;
	controller.btns.minus = false;
	controller.btns.capture = false;

	controller.btns.a = false;
	controller.btns.b = false;
	controller.btns.x = false;
	controller.btns.y = false;
	controller.btns.stick_button2 = false;
	controller.btns.r = false;
	controller.btns.zr = false;
	controller.btns.plus = false;
	controller.btns.home = false;

	controller.reset = function() {
		for (let prop in controller.btns) {
			controller.btns[prop] = false;
		}
		controller.LStick.x = 128;
		controller.LStick.y = 128;
		controller.RStick.x = 128;
		controller.RStick.y = 128;
	}

	var oldControllerState = "";


	function sendKeyboardInputs() {

		if (!document.getElementById("keyboardController").checked) {
			return;
		}

		controller.reset();

		if (key.isPressed("W")) {
			controller.LStick.y = 255;
		}
		if (key.isPressed("S")) {
			controller.LStick.y = 0;
		}
		if (key.isPressed("A")) {
			controller.LStick.x = 0;
		}
		if (key.isPressed("D")) {
			controller.LStick.x = 255;
		}

		if (key.isPressed("up")) {
			controller.btns.x = true;
		}
		if (key.isPressed("down")) {
			controller.btns.b = true;
		}
		if (key.isPressed("left")) {
			controller.btns.y = true;
		}
		if (key.isPressed("right")) {
			controller.btns.a = true;
		}

		//     if(key.isPressed("space")) {
		//       controller.btns.b = true;
		//     }


		if (key.isPressed("I")) {
			controller.RStick.y = 255;
		}
		if (key.isPressed("K")) {
			controller.RStick.y = 0;
		}
		if (key.isPressed("J")) {
			controller.RStick.x = 0;
		}
		if (key.isPressed("L")) {
			controller.RStick.x = 255;
		}

		if (key.isPressed("O")) {
			controller.btns.minus = true;
		}

		if (key.isPressed("F")) {
			controller.btns.down = true;
		}
    
// 		if (key.isPressed("C")) {
// 			socket.emit("chat message", "cap bounce");
// 		}



		let newControllerState = "";

		if (controller.btns.up == 1 && controller.btns.left == 1) {
			newControllerState += "7";
		} else if (controller.btns.up && controller.btns.right == 1) {
			newControllerState += "1";
		} else if (controller.btns.down == 1 && controller.btns.left == 1) {
			newControllerState += "5";
		} else if (controller.btns.down == 1 && controller.btns.right == 1) {
			newControllerState += "3";
		} else if (controller.btns.up == 1) {
			newControllerState += "0";
		} else if (controller.btns.down == 1) {
			newControllerState += "4";
		} else if (controller.btns.left == 1) {
			newControllerState += "6";
		} else if (controller.btns.right == 1) {
			newControllerState += "2";
		} else {
			newControllerState += "8";
		}

		newControllerState += controller.btns.stick_button == 1 ? "1" : "0";
		newControllerState += controller.btns.l == 1 ? "1" : "0";
		newControllerState += controller.btns.zl == 1 ? "1" : "0";
		newControllerState += controller.btns.minus == 1 ? "1" : "0";
		newControllerState += controller.btns.capture == 1 ? "1" : "0";

		newControllerState += controller.btns.a == 1 ? "1" : "0";
		newControllerState += controller.btns.b == 1 ? "1" : "0";
		newControllerState += controller.btns.x == 1 ? "1" : "0";
		newControllerState += controller.btns.y == 1 ? "1" : "0";
		newControllerState += controller.btns.stick_button2 == 1 ? "1" : "0";
		newControllerState += controller.btns.r == 1 ? "1" : "0";
		newControllerState += controller.btns.zr == 1 ? "1" : "0";
		newControllerState += controller.btns.plus == 1 ? "1" : "0";
		newControllerState += controller.btns.home == 1 ? "1" : "0";


		var LX = controller.LStick.x;
		var LY = controller.LStick.y;
		var RX = controller.RStick.x;
		var RY = controller.RStick.y;

		newControllerState += " " + LX + " " + LY + " " + RX + " " + RY;


		if (newControllerState == oldControllerState) {
			return;
		} else {
			oldControllerState = newControllerState;
		}
		console.log(newControllerState);
		socket.emit("sendControllerState", newControllerState);
	}



	setInterval(sendKeyboardInputs, 10);

	//updateImage();

	// 	setInterval(function() {
	// 		var user = $("#directedTarget").val();
	// 		directedGetImage(user);
	// 	}, 100);
</script>